  <!DOCTYPE html>
  <html lang="ko">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>A4LAB_DATA</title>
    <style>
      :root {
        --min-card-width: 280px;
        --grid-gap: 10px;
        --container-padding: 15px;
      }

      body {
        display: flex;
        flex-direction: column;
        align-items: center;
        font-family: 'Poppins', sans-serif;
        background: linear-gradient(120deg, #2b2b5a, #000030);
        color: #ffffff;
        margin: 0;
        padding: var(--container-padding);
        min-height: 100vh;
        animation: gradientBG 15s ease infinite;
        background-size: 400% 400%;
        overflow-x: hidden;
      }

      @keyframes gradientBG {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
      }

      .main-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(var(--min-card-width), 1fr));
        gap: var(--grid-gap);
        width: 100%;
        max-width: 1600px;
        margin: 20px auto;
      }

      .sensor-container {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: var(--grid-gap);
        width: 100%;
        height: fit-content;
      }

      .chart-container {
        aspect-ratio: 16/9;
        min-height: 300px;
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border-radius: 25px;
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
        padding: 20px;
        border: 1px solid rgba(255, 255, 255, 0.18);
      }

      .data-display {
        aspect-ratio: 2/1;
        min-height: 60px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        border-radius: 25px;
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
        font-size: clamp(20px, 1.8vw, 25px);
        font-weight: 1000;
        text-align: center;
        cursor: pointer;
        border: 1px solid rgba(255, 255, 255, 0.18);
        padding: 30px;
      }

      h1 {
        text-align: center;
        font-size: clamp(24px, 4vw, 36px);
        font-weight: 700;
        margin: 15px 0;
        text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.2);
        letter-spacing: 2px;
        width: 100%;
      }

      .control-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(var(--min-card-width), 1fr));
        gap: var(--grid-gap);
        width: 100%;
        max-width: 1600px;
        margin: 20px auto;
      }

      .device-control {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        padding: 20px;
        border-radius: 25px;
        display: flex;
        flex-direction: column;
        gap: 15px;
        align-items: center;
        border: 1px solid rgba(255, 255, 255, 0.18);
        min-height: 150px;
        justify-content: space-between;
      }

      .device-buttons {
        display: flex;
        gap: 10px;
        justify-content: center;
        width: 100%;
      }

      .device-btn {
        flex: 1;
        padding: 12px;
        font-size: clamp(14px, 2vw, 16px);
        font-weight: 600;
        color: white;
        border: none;
        border-radius: 12px;
        cursor: pointer;
        text-transform: uppercase;
        letter-spacing: 1px;
        max-width: 150px;
      }

      .on-btn {
        background: linear-gradient(135deg, #c5bf62, #2bff72);
      }

      .off-btn {
        background: linear-gradient(135deg, #636060, #939793);
      }

      #camera-container {
      width: 100%;
      max-width: 1600px;
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: var(--grid-gap);
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      padding: 20px;
      border-radius: 25px;
      border: 1px solid rgba(255, 255, 255, 0.18);
      margin: 20px auto;
}

      #camera-container h2 {
        font-size: clamp(20px, 3vw, 28px);
        font-weight: 600;
        margin-bottom: 15px;
        text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.2);
        grid-column: 1 / -1;
        text-align: center;
      }

      .camera-feed {
        width: 100%;
        max-width: 640px;
        aspect-ratio: 16/9;
        border-radius: 25px;
        border: 1px solid rgba(255, 255, 255, 0.18);
        display: block;
        margin: 0 auto;
      }

      @media screen and (orientation: portrait) {
        :root {
          --min-card-width: 100%;
          --grid-gap: 12px;
          --container-padding: 8px;
        }

        .main-container,
        .sensor-container,
        .control-container,
        #camera-container {
          grid-template-columns: 1fr;
        }

        .data-display {
          aspect-ratio: auto;
          min-height: 60px;
          padding: 10px;
          font-size: clamp(14px, 2vw, 18px);
        }

        .device-control {
          aspect-ratio: auto;
          min-height: 80px;
          flex-direction: row;
          justify-content: space-between;
          padding: 12px;
        }

        .device-buttons {
          width: auto;
        }

        .device-btn {
          padding: 8px;
          font-size: 12px;
          min-width: 60px;
        }

        .chart-container {
          aspect-ratio: auto;
          min-height: 250px;
          padding: 12px;
        }

        #camera-container {
          padding: 12px;
        }

        #camera-container h2 {
          font-size: clamp(18px, 2.5vw, 24px);
          margin-bottom: 10px;
        }
      }

      @media screen and (max-width: 480px) {
        :root {
          --min-card-width: 100%;
          --grid-gap: 8px;
          --container-padding: 6px;
        }

        .device-btn {
          padding: 6px;
          font-size: 12px;
          min-width: 50px;
        }
      }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  </head>
  <body>
    <h1>A4LAB IoT System</h1>

    <div class="main-container">
      <div class="sensor-container">
        <div id="temperatureDisplay" class="data-display" onclick="toggleChart('temperature')">Temperature: -- °C</div>
        <div id="humidityDisplay" class="data-display" onclick="toggleChart('humidity')">Humidity: -- %</div>
        <div id="lightDisplay" class="data-display" onclick="toggleChart('light')">Light: -- lux</div>
        <div id="soilMoistureDisplay" class="data-display" onclick="toggleChart('soilMoisture')">Soil Moisture: -- %</div>
      </div>
      <div class="chart-container">
        <canvas id="sensorChart"></canvas>
      </div>
    </div>

    <div class="control-container">
      <div class="device-control">
        <div id="windowDisplay">Window Status: CLOSED</div>
        <div class="device-buttons">
          <button class="device-btn on-btn" onclick="setDevice('window', 1)">OPEN</button>
          <button class="device-btn off-btn" onclick="setDevice('window', 0)">CLOSE</button>
        </div>
      </div>
      <div class="device-control">
        <div id="valveDisplay">Valve Status: CLOSED</div>
        <div class="device-buttons">
          <button class="device-btn on-btn" onclick="setDevice('valve', 1)">OPEN</button>
          <button class="device-btn off-btn" onclick="setDevice('valve', 0)">CLOSE</button>
        </div>
      </div>
      <div class="device-control">
        <div id="ledDisplay">LED Status: OFF</div>
        <div class="device-buttons">
          <button class="device-btn on-btn" onclick="setDevice('led', 1)">ON</button>
          <button class="device-btn off-btn" onclick="setDevice('led', 0)">OFF</button>
        </div>
      </div>
      <div class="device-control">
        <div id="fanDisplay">Fan Status: OFF</div>
        <div class="device-buttons">
          <button class="device-btn on-btn" onclick="setDevice('fan', 1)">ON</button>
          <button class="device-btn off-btn" onclick="setDevice('fan', 0)">OFF</button>
        </div>
      </div>
    </div>

    <div id="camera-container">
      <div class="camera-section">
        <h2>실험군</h2>
        <img class="camera-feed" src="http://192.168.0.54:81/stream" alt="ESP32-CAM Feed 1">
      </div>
      <div class="camera-section">
        <h2>대조군</h2>
        <img class="camera-feed" src="http://192.168.0.69:81/stream" alt="ESP32-CAM Feed 2">
      </div>
    </div>

    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      const esp32CamIp1 = "http://192.168.0.54:81/stream";
      const esp32CamIp2 = "http://192.168.0.69:81/stream";
      document.querySelectorAll(".camera-feed")[0].src = esp32CamIp1;
      document.querySelectorAll(".camera-feed")[1].src = esp32CamIp2;

      const client = mqtt.connect("ws://broker.hivemq.com:8000/mqtt");
      const topics = {
        temperature: "garden/temperature",
        humidity: "garden/humidity", 
        light: "garden/light",
        soilMoisture: "garden/soil_moisture",
        window: "garden/Window",
        valve: "garden/Valve",
        led: "garden/Light",
        fan: "garden/Fan"
      };

      const deviceStates = {
        window: 0,
        valve: 0,
        led: 0,
        fan: 0
      };

      const dataBuffers = {
        temperature: [],
        humidity: [],
        light: [],
        soilMoisture: []
      };

      const maxDataPoints = 50;
      let chartInstance;
      let activeSensor = null;

      function updateDisplay(elementId, value, unit) {
        const element = document.getElementById(elementId);
        if (unit) {
          element.textContent = `${elementId.replace("Display", "")} : ${value} ${unit}`;
        } else {
          if (elementId === "windowDisplay" || elementId === "valveDisplay") {
            element.textContent = `${elementId.replace("Display", "")} Status: ${value === 1 ? "OPEN" : "CLOSED"}`;
          } else {  
            element.textContent = `${elementId.replace("Display", "")} Status: ${value === 1 ? "ON" : "OFF"}`;
          }
        }
      }

      function setDevice(device, state) {
        deviceStates[device] = state;
        client.publish(topics[device], String(state));
        updateDisplay(`${device}Display`, state);
      }

      function toggleChart(sensor) {
        const ctx = document.getElementById("sensorChart").getContext("2d");

        if (chartInstance) {
          chartInstance.destroy();
        }

        chartInstance = new Chart(ctx, {
          type: 'line',
          data: {
            labels: Array(dataBuffers[sensor].length).fill('').map((_, i) => i + 1),
            datasets: [{
              label: `${sensor} Data`,
              data: dataBuffers[sensor],
              borderColor: '#00F260',
              backgroundColor: 'rgba(0, 242, 96, 0.2)',
              borderWidth: 3,
              tension: 0.4,
              pointRadius: 4,
              pointHoverRadius: 6,
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                labels: {
                  font: {
                    family: 'Poppins',
                    size: 14,
                    weight: '500'
                  },
                  color: '#ffffff'
                }
              }
            },
            scales: {
              x: { 
                title: { 
                  display: true, 
                  text: 'Time',
                  font: {
                    family: 'Poppins',
                    size: 14,
                    weight: '500'
                  },
                  color: '#ffffff'
                },
                grid: {
                  color: 'rgba(255, 255, 255, 0.1)'
                },
                ticks: {
                  color: '#ffffff'
                }
              },
              y: { 
                title: { 
                  display: true, 
                  text: sensor,
                  font: {
                    family: 'Poppins',
                    size: 14,
                    weight: '500'
                  },
                  color: '#ffffff'
                },
                grid: {
                  color: 'rgba(255, 255, 255, 0.1)'
                },
                ticks: {
                  color: '#ffffff'
                }
              }
            }
          }
        });
      }

      client.on("connect", () => {
        console.log("Connected to MQTT Broker");
        Object.values(topics).forEach(topic => client.subscribe(topic));
      });

      client.on("message", (topic, message) => {
        const value = parseFloat(message.toString().trim());

        if (topic === topics.temperature) {
          updateDisplay("temperatureDisplay", value.toFixed(1), "°C");
          updateBuffer("temperature", value);
        } else if (topic === topics.humidity) {
          updateDisplay("humidityDisplay", value.toFixed(1), "%");
          updateBuffer("humidity", value);
        } else if (topic === topics.light) {
          updateDisplay("lightDisplay", value.toFixed(1), "lux");
          updateBuffer("light", value);
        } else if (topic === topics.soilMoisture) {
          updateDisplay("soilMoistureDisplay", value.toFixed(1), "%");
          updateBuffer("soilMoisture", value);
        } else if (topic === topics.window) {
          updateDisplay("windowDisplay", value);
        } else if (topic === topics.valve) {
          updateDisplay("valveDisplay", value);
        } else if (topic === topics.led) {
          updateDisplay("ledDisplay", value);
        } else if (topic === topics.fan) {
          updateDisplay("fanDisplay", value);
        }
      });

      function updateBuffer(sensor, value) {
        if (dataBuffers[sensor].length >= maxDataPoints) {
          dataBuffers[sensor].shift();
        }
        dataBuffers[sensor].push(value);
      }
    </script>
  </body>
  </html>
